# SAM Nunchaku Backbone W4A8 Quantization Configuration
# 4-bit weights, 8-bit activations

quant:
  # Calibration settings
  calib:
    num_samples: 128
    batch_size: 1

  # Weight quantization - 4-bit
  wgts:
    dtype: uint4                    # 4-bit unsigned integer
    zero_point: PostScale           # Zero point after scaling
    static: true                    # Static quantization for weights
    group_shapes:
      - [1, 128]                    # Per-channel with group size 128
    scale_dtypes:
      - torch.float16               # FP16 scales

    # GPTQ configuration for better accuracy
    enable_kernel_gptq: true
    kernel_gptq:
      damp_percentage: 0.01         # Damping factor
      block_size: 128               # Block size for GPTQ
      num_inv_tries: 250            # Number of inverse attempts
      hessian_block_size: 512       # Hessian matrix block size
      skips: []                     # No skips

    # Skip certain layers
    skip_patch_embed: true          # Don't quantize patch embedding (first layer)
    skip_first_block: false         # Quantize first transformer block
    skip_last_block: false          # Quantize last transformer block
    skip_decoder: false             # Quantize decoder

    # Low-rank branch (SVDQuant) - optional, uncomment to enable
    # low_rank:
    #   rank: 32
    #   compensate: true

    # Dynamic range calibration
    enable_calib_range: false
    calib_range:
      objective: TensorError
      strategy: GridSearch
      granularity: Group
      degree: 2.4
      num_grids: 100

  # Input activation quantization - 8-bit
  ipts:
    dtype: uint8                    # 8-bit unsigned integer
    zero_point: PostScale
    static: false                   # Dynamic quantization for activations
    per_token: true                 # Per-token quantization
    group_shapes:
      - [1, -1]                     # Per-token (batch, seq_length)
    scale_dtypes:
      - torch.float16

    # Calibration for activations
    enable_calib_range: true
    calib_range:
      objective: TensorError
      strategy: GridSearch
      granularity: Group
      degree: 2.4
      num_grids: 100

  # Output activation quantization - 8-bit
  opts:
    dtype: uint8
    zero_point: PostScale
    static: false
    per_token: true
    group_shapes:
      - [1, -1]
    scale_dtypes:
      - torch.float16

    enable_calib_range: true
    calib_range:
      objective: TensorError
      strategy: GridSearch
      granularity: Group
      degree: 2.4
      num_grids: 100

  # Rotation (optional, disable for now)
  rotation:
    enabled: false

  # Smooth quantization (optional, disable for now)
  smooth:
    enabled: false
    alpha: 0.5
